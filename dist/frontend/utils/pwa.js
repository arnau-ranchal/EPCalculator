"use strict";
// Progressive Web App utilities and installation helpers\n\n// PWA installation prompt management\nlet deferredPrompt: any = null\nlet installPromptShown = false\n\n// Listen for beforeinstallprompt event\nwindow.addEventListener('beforeinstallprompt', (e) => {\n  console.log('üíæ PWA install prompt available')\n  \n  // Prevent the mini-infobar from appearing on mobile\n  e.preventDefault()\n  \n  // Store the event so it can be triggered later\n  deferredPrompt = e\n  \n  // Show custom install button/banner\n  showInstallPrompt()\n})\n\n// Listen for app installation\nwindow.addEventListener('appinstalled', () => {\n  console.log('‚úÖ PWA installed successfully')\n  hideInstallPrompt()\n  deferredPrompt = null\n  \n  // Track installation\n  trackPWAInstallation()\n})\n\n// Service Worker registration and management\nexport async function registerServiceWorker(): Promise<ServiceWorkerRegistration | null> {\n  if (!('serviceWorker' in navigator)) {\n    console.warn('‚ö†Ô∏è Service Workers not supported')\n    return null\n  }\n\n  try {\n    const registration = await navigator.serviceWorker.register('/sw.js', {\n      scope: '/'\n    })\n\n    console.log('‚úÖ Service Worker registered:', registration.scope)\n\n    // Handle updates\n    registration.addEventListener('updatefound', () => {\n      const newWorker = registration.installing\n      if (newWorker) {\n        newWorker.addEventListener('statechange', () => {\n          if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {\n            showUpdateAvailable()\n          }\n        })\n      }\n    })\n\n    return registration\n  } catch (error) {\n    console.error('‚ùå Service Worker registration failed:', error)\n    return null\n  }\n}\n\n// Check if app is installable\nexport function canInstallPWA(): boolean {\n  return deferredPrompt !== null\n}\n\n// Check if app is already installed\nexport function isPWAInstalled(): boolean {\n  return (\n    window.matchMedia('(display-mode: standalone)').matches ||\n    window.matchMedia('(display-mode: fullscreen)').matches ||\n    (window.navigator as any).standalone === true // iOS\n  )\n}\n\n// Trigger PWA installation\nexport async function installPWA(): Promise<boolean> {\n  if (!deferredPrompt) {\n    console.warn('‚ö†Ô∏è PWA installation not available')\n    return false\n  }\n\n  try {\n    // Show the install prompt\n    deferredPrompt.prompt()\n\n    // Wait for the user to respond to the prompt\n    const { outcome } = await deferredPrompt.userChoice\n\n    if (outcome === 'accepted') {\n      console.log('‚úÖ User accepted PWA installation')\n      return true\n    } else {\n      console.log('‚ùå User dismissed PWA installation')\n      return false\n    }\n  } catch (error) {\n    console.error('‚ùå PWA installation failed:', error)\n    return false\n  } finally {\n    deferredPrompt = null\n  }\n}\n\n// Show custom install prompt\nfunction showInstallPrompt(): void {\n  // Don't show if already installed or prompt already shown\n  if (isPWAInstalled() || installPromptShown) {\n    return\n  }\n\n  installPromptShown = true\n\n  // Create install banner\n  const banner = document.createElement('div')\n  banner.id = 'pwa-install-banner'\n  banner.innerHTML = `\n    <div style=\"\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      background: #C8102E;\n      color: white;\n      padding: 12px 16px;\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      z-index: 10000;\n      font-family: 'Inter', sans-serif;\n      font-size: 14px;\n      box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n    \">\n      <div style=\"display: flex; align-items: center; gap: 12px;\">\n        <span style=\"font-size: 18px;\">üì±</span>\n        <span>Install EPCalculator for offline access and better performance</span>\n      </div>\n      <div style=\"display: flex; gap: 8px;\">\n        <button id=\"pwa-install-btn\" style=\"\n          background: white;\n          color: #C8102E;\n          border: none;\n          padding: 6px 12px;\n          border-radius: 4px;\n          font-weight: 500;\n          cursor: pointer;\n          font-size: 12px;\n        \">Install</button>\n        <button id=\"pwa-dismiss-btn\" style=\"\n          background: transparent;\n          color: white;\n          border: 1px solid white;\n          padding: 6px 12px;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 12px;\n        \">Later</button>\n      </div>\n    </div>\n  `\n\n  document.body.appendChild(banner)\n\n  // Add event listeners\n  document.getElementById('pwa-install-btn')?.addEventListener('click', async () => {\n    const installed = await installPWA()\n    if (installed) {\n      hideInstallPrompt()\n    }\n  })\n\n  document.getElementById('pwa-dismiss-btn')?.addEventListener('click', () => {\n    hideInstallPrompt()\n    // Don't show again for this session\n    sessionStorage.setItem('pwa-prompt-dismissed', 'true')\n  })\n\n  // Auto-hide after 10 seconds\n  setTimeout(() => {\n    if (document.getElementById('pwa-install-banner')) {\n      hideInstallPrompt()\n    }\n  }, 10000)\n}\n\n// Hide install prompt\nfunction hideInstallPrompt(): void {\n  const banner = document.getElementById('pwa-install-banner')\n  if (banner) {\n    banner.remove()\n  }\n}\n\n// Show update available notification\nfunction showUpdateAvailable(): void {\n  const notification = document.createElement('div')\n  notification.id = 'pwa-update-notification'\n  notification.innerHTML = `\n    <div style=\"\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      background: #333;\n      color: white;\n      padding: 16px 20px;\n      border-radius: 8px;\n      box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n      z-index: 10000;\n      font-family: 'Inter', sans-serif;\n      font-size: 14px;\n      max-width: 300px;\n    \">\n      <div style=\"margin-bottom: 12px;\">\n        <strong>üì± Update Available</strong>\n      </div>\n      <div style=\"margin-bottom: 16px; font-size: 13px; opacity: 0.9;\">\n        A new version of EPCalculator is available with improvements and bug fixes.\n      </div>\n      <div style=\"display: flex; gap: 8px;\">\n        <button id=\"pwa-update-btn\" style=\"\n          background: #C8102E;\n          color: white;\n          border: none;\n          padding: 8px 16px;\n          border-radius: 4px;\n          font-size: 12px;\n          cursor: pointer;\n        \">Update Now</button>\n        <button id=\"pwa-update-dismiss\" style=\"\n          background: transparent;\n          color: #ccc;\n          border: 1px solid #555;\n          padding: 8px 16px;\n          border-radius: 4px;\n          font-size: 12px;\n          cursor: pointer;\n        \">Later</button>\n      </div>\n    </div>\n  `\n\n  document.body.appendChild(notification)\n\n  // Add event listeners\n  document.getElementById('pwa-update-btn')?.addEventListener('click', () => {\n    updateServiceWorker()\n    notification.remove()\n  })\n\n  document.getElementById('pwa-update-dismiss')?.addEventListener('click', () => {\n    notification.remove()\n  })\n}\n\n// Update Service Worker\nfunction updateServiceWorker(): void {\n  if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {\n    navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' })\n    window.location.reload()\n  }\n}\n\n// Get PWA capabilities\nexport function getPWACapabilities(): {\n  serviceWorker: boolean\n  webAppManifest: boolean\n  installPrompt: boolean\n  standalone: boolean\n  notifications: boolean\n  backgroundSync: boolean\n  push: boolean\n} {\n  return {\n    serviceWorker: 'serviceWorker' in navigator,\n    webAppManifest: 'onbeforeinstallprompt' in window,\n    installPrompt: deferredPrompt !== null,\n    standalone: isPWAInstalled(),\n    notifications: 'Notification' in window,\n    backgroundSync: 'serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype,\n    push: 'serviceWorker' in navigator && 'PushManager' in window\n  }\n}\n\n// Request notification permission\nexport async function requestNotificationPermission(): Promise<NotificationPermission> {\n  if (!('Notification' in window)) {\n    console.warn('‚ö†Ô∏è Notifications not supported')\n    return 'denied'\n  }\n\n  if (Notification.permission === 'default') {\n    const permission = await Notification.requestPermission()\n    console.log('üîî Notification permission:', permission)\n    return permission\n  }\n\n  return Notification.permission\n}\n\n// Show notification\nexport function showNotification(\n  title: string,\n  options: NotificationOptions = {}\n): void {\n  if (!('Notification' in window) || Notification.permission !== 'granted') {\n    console.warn('‚ö†Ô∏è Cannot show notification: not supported or permission denied')\n    return\n  }\n\n  const defaultOptions: NotificationOptions = {\n    icon: '/icons/icon-192x192.png',\n    badge: '/icons/icon-72x72.png',\n    tag: 'epcalculator',\n    renotify: false,\n    requireInteraction: false\n  }\n\n  new Notification(title, { ...defaultOptions, ...options })\n}\n\n// Track PWA installation for analytics\nfunction trackPWAInstallation(): void {\n  try {\n    // Track installation event\n    localStorage.setItem('pwa-installed', Date.now().toString())\n    localStorage.setItem('pwa-install-count', \n      (parseInt(localStorage.getItem('pwa-install-count') || '0') + 1).toString()\n    )\n    \n    // Could send analytics to server if needed\n    console.log('üìä PWA installation tracked')\n  } catch (error) {\n    console.error('Failed to track PWA installation:', error)\n  }\n}\n\n// Get PWA usage statistics\nexport function getPWAStats(): {\n  installed: boolean\n  installDate: number | null\n  installCount: number\n  serviceWorkerActive: boolean\n  cacheSize: number | null\n} {\n  return {\n    installed: isPWAInstalled(),\n    installDate: parseInt(localStorage.getItem('pwa-installed') || '0') || null,\n    installCount: parseInt(localStorage.getItem('pwa-install-count') || '0'),\n    serviceWorkerActive: navigator.serviceWorker?.controller !== null,\n    cacheSize: null // Would need to query service worker\n  }\n}\n\n// Initialize PWA features\nexport async function initializePWA(): Promise<void> {\n  console.log('üöÄ Initializing PWA features...')\n\n  // Register service worker\n  await registerServiceWorker()\n\n  // Check if should show install prompt\n  const dismissed = sessionStorage.getItem('pwa-prompt-dismissed')\n  if (!dismissed && !isPWAInstalled()) {\n    // Install prompt will be shown when beforeinstallprompt event fires\n  }\n\n  // Request notification permission if not already granted\n  if ('Notification' in window && Notification.permission === 'default') {\n    // Could show explanation before requesting permission\n    // await requestNotificationPermission()\n  }\n\n  console.log('‚úÖ PWA initialization complete')\n  console.log('PWA capabilities:', getPWACapabilities())\n}"
