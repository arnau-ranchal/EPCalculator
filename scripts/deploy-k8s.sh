#!/bin/bash\n\n# Kubernetes deployment script for EPCalculator v2\n# Optimized for university server infrastructure\n\nset -e\n\n# Configuration\nNAMESPACE=\"epcalculator\"\nIMAGE_NAME=\"epcalculator\"\nIMAGE_TAG=\"2.0\"\nUNIVERSITY_REGISTRY=\"registry.upf.edu\"  # Adjust to your university's registry\n\n# Colors for output\nRED='\\033[0;31m'\nGREEN='\\033[0;32m'\nYELLOW='\\033[1;33m'\nBLUE='\\033[0;34m'\nNC='\\033[0m' # No Color\n\necho -e \"${BLUE}üöÄ EPCalculator v2 Kubernetes Deployment${NC}\"\necho -e \"${BLUE}==========================================${NC}\"\necho \"\"\n\n# Check prerequisites\nfunction check_prerequisites() {\n    echo -e \"${YELLOW}üîç Checking prerequisites...${NC}\"\n    \n    # Check kubectl\n    if ! command -v kubectl &> /dev/null; then\n        echo -e \"${RED}‚ùå kubectl not found. Please install kubectl.${NC}\"\n        exit 1\n    fi\n    \n    # Check cluster connectivity\n    if ! kubectl cluster-info &> /dev/null; then\n        echo -e \"${RED}‚ùå Cannot connect to Kubernetes cluster.${NC}\"\n        exit 1\n    fi\n    \n    # Check Docker (for building)\n    if ! command -v docker &> /dev/null; then\n        echo -e \"${RED}‚ùå Docker not found. Please install Docker.${NC}\"\n        exit 1\n    fi\n    \n    echo -e \"${GREEN}‚úÖ Prerequisites check passed${NC}\"\n}\n\n# Build and tag the Docker image\nfunction build_image() {\n    echo -e \"${YELLOW}üèóÔ∏è Building Docker image...${NC}\"\n    \n    # Build optimized image\n    docker build -f Dockerfile.v2 -t ${IMAGE_NAME}:${IMAGE_TAG} .\n    \n    # Tag for university registry\n    docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${UNIVERSITY_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}\n    \n    echo -e \"${GREEN}‚úÖ Docker image built successfully${NC}\"\n}\n\n# Push image to university registry\nfunction push_image() {\n    echo -e \"${YELLOW}üì§ Pushing image to university registry...${NC}\"\n    \n    # Login to registry (adjust authentication as needed)\n    # docker login ${UNIVERSITY_REGISTRY}\n    \n    # Push image\n    docker push ${UNIVERSITY_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}\n    \n    echo -e \"${GREEN}‚úÖ Image pushed successfully${NC}\"\n}\n\n# Create namespace and basic resources\nfunction create_namespace() {\n    echo -e \"${YELLOW}üìù Creating namespace and resources...${NC}\"\n    \n    kubectl apply -f k8s/namespace.yaml\n    \n    echo -e \"${GREEN}‚úÖ Namespace created${NC}\"\n}\n\n# Deploy storage resources\nfunction deploy_storage() {\n    echo -e \"${YELLOW}üíæ Deploying storage resources...${NC}\"\n    \n    # Create local directory on university server (adjust path as needed)\n    echo \"Creating local storage directory...\"\n    # kubectl exec -it -n kube-system $(kubectl get pods -n kube-system -l component=kube-apiserver -o name | head -1) -- mkdir -p /opt/epcalculator/data\n    \n    kubectl apply -f k8s/storage.yaml\n    \n    echo -e \"${GREEN}‚úÖ Storage resources deployed${NC}\"\n}\n\n# Deploy configuration\nfunction deploy_config() {\n    echo -e \"${YELLOW}‚öôÔ∏è Deploying configuration...${NC}\"\n    \n    kubectl apply -f k8s/configmap.yaml\n    \n    echo -e \"${GREEN}‚úÖ Configuration deployed${NC}\"\n}\n\n# Deploy application\nfunction deploy_application() {\n    echo -e \"${YELLOW}üöÄ Deploying application...${NC}\"\n    \n    # Update image in deployment\n    sed -i.bak \"s|image: epcalculator:2.0|image: ${UNIVERSITY_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}|g\" k8s/deployment.yaml\n    \n    kubectl apply -f k8s/deployment.yaml\n    kubectl apply -f k8s/service.yaml\n    \n    # Restore original deployment file\n    mv k8s/deployment.yaml.bak k8s/deployment.yaml\n    \n    echo -e \"${GREEN}‚úÖ Application deployed${NC}\"\n}\n\n# Deploy ingress and networking\nfunction deploy_networking() {\n    echo -e \"${YELLOW}üåê Deploying networking...${NC}\"\n    \n    kubectl apply -f k8s/ingress.yaml\n    \n    echo -e \"${GREEN}‚úÖ Networking deployed${NC}\"\n}\n\n# Deploy monitoring (optional)\nfunction deploy_monitoring() {\n    echo -e \"${YELLOW}üìä Deploying monitoring (optional)...${NC}\"\n    \n    # Check if Prometheus operator is available\n    if kubectl get crd servicemonitors.monitoring.coreos.com &> /dev/null; then\n        kubectl apply -f k8s/monitoring.yaml\n        echo -e \"${GREEN}‚úÖ Monitoring deployed${NC}\"\n    else\n        echo -e \"${YELLOW}‚ö†Ô∏è Prometheus operator not found, skipping monitoring deployment${NC}\"\n    fi\n}\n\n# Wait for deployment to be ready\nfunction wait_for_deployment() {\n    echo -e \"${YELLOW}‚è≥ Waiting for deployment to be ready...${NC}\"\n    \n    kubectl wait --for=condition=available --timeout=300s deployment/epcalculator -n ${NAMESPACE}\n    \n    echo -e \"${GREEN}‚úÖ Deployment is ready${NC}\"\n}\n\n# Show deployment status\nfunction show_status() {\n    echo -e \"${BLUE}üìä Deployment Status${NC}\"\n    echo -e \"${BLUE}===================${NC}\"\n    \n    echo \"\"\n    echo \"Pods:\"\n    kubectl get pods -n ${NAMESPACE}\n    \n    echo \"\"\n    echo \"Services:\"\n    kubectl get services -n ${NAMESPACE}\n    \n    echo \"\"\n    echo \"Ingress:\"\n    kubectl get ingress -n ${NAMESPACE}\n    \n    echo \"\"\n    echo \"Storage:\"\n    kubectl get pvc -n ${NAMESPACE}\n    \n    # Get external IP/URL\n    echo \"\"\n    echo -e \"${GREEN}üéâ EPCalculator v2 deployed successfully!${NC}\"\n    \n    EXTERNAL_IP=$(kubectl get ingress epcalculator-ingress -n ${NAMESPACE} -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo \"Pending...\")\n    EXTERNAL_HOSTNAME=$(kubectl get ingress epcalculator-ingress -n ${NAMESPACE} -o jsonpath='{.spec.rules[0].host}' 2>/dev/null || echo \"Not configured\")\n    \n    echo \"\"\n    echo \"Access URLs:\"\n    echo \"  External IP: ${EXTERNAL_IP}\"\n    echo \"  Hostname: ${EXTERNAL_HOSTNAME}\"\n    echo \"  Local (port-forward): kubectl port-forward svc/epcalculator-frontend 8080:80 -n ${NAMESPACE}\"\n}\n\n# Cleanup function\nfunction cleanup() {\n    echo -e \"${YELLOW}üßπ Cleaning up deployment...${NC}\"\n    \n    kubectl delete namespace ${NAMESPACE} --ignore-not-found=true\n    \n    echo -e \"${GREEN}‚úÖ Cleanup completed${NC}\"\n}\n\n# Show help\nfunction show_help() {\n    echo \"EPCalculator v2 Kubernetes Deployment Script\"\n    echo \"\"\n    echo \"Usage: $0 [COMMAND]\"\n    echo \"\"\n    echo \"Commands:\"\n    echo \"  deploy    - Full deployment (default)\"\n    echo \"  build     - Build Docker image only\"\n    echo \"  push      - Push image to registry\"\n    echo \"  update    - Update existing deployment\"\n    echo \"  status    - Show deployment status\"\n    echo \"  cleanup   - Remove all resources\"\n    echo \"  help      - Show this help\"\n    echo \"\"\n    echo \"Examples:\"\n    echo \"  $0 deploy   # Full deployment\"\n    echo \"  $0 status   # Check status\"\n    echo \"  $0 cleanup  # Remove everything\"\n}\n\n# Main deployment function\nfunction deploy_all() {\n    check_prerequisites\n    build_image\n    push_image\n    create_namespace\n    deploy_storage\n    deploy_config\n    deploy_application\n    deploy_networking\n    deploy_monitoring\n    wait_for_deployment\n    show_status\n}\n\n# Update deployment function\nfunction update_deployment() {\n    echo -e \"${YELLOW}üîÑ Updating deployment...${NC}\"\n    \n    build_image\n    push_image\n    \n    # Rolling update\n    kubectl set image deployment/epcalculator epcalculator=${UNIVERSITY_REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} -n ${NAMESPACE}\n    kubectl rollout status deployment/epcalculator -n ${NAMESPACE}\n    \n    echo -e \"${GREEN}‚úÖ Deployment updated${NC}\"\n}\n\n# Parse command line arguments\ncase \"${1:-deploy}\" in\n    \"deploy\")\n        deploy_all\n        ;;\n    \"build\")\n        check_prerequisites\n        build_image\n        ;;\n    \"push\")\n        check_prerequisites\n        push_image\n        ;;\n    \"update\")\n        check_prerequisites\n        update_deployment\n        ;;\n    \"status\")\n        show_status\n        ;;\n    \"cleanup\")\n        cleanup\n        ;;\n    \"help\")\n        show_help\n        ;;\n    *)\n        echo -e \"${RED}‚ùå Unknown command: $1${NC}\"\n        show_help\n        exit 1\n        ;;\nesac"