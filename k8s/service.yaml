apiVersion: v1\nkind: Service\nmetadata:\n  name: epcalculator-backend\n  namespace: epcalculator\n  labels:\n    app: epcalculator\n    component: backend\n    service-type: backend\nspec:\n  type: ClusterIP\n  ports:\n  - port: 8000\n    targetPort: 8000\n    protocol: TCP\n    name: http\n  selector:\n    app: epcalculator\n    component: backend\n  sessionAffinity: ClientIP  # For session stickiness\n  sessionAffinityConfig:\n    clientIP:\n      timeoutSeconds: 3600  # 1 hour\n\n---\napiVersion: v1\nkind: Service\nmetadata:\n  name: epcalculator-frontend\n  namespace: epcalculator\n  labels:\n    app: epcalculator\n    component: frontend\n    service-type: web\n  annotations:\n    service.beta.kubernetes.io/aws-load-balancer-type: \"nlb\"\n    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: \"http\"\nspec:\n  type: LoadBalancer  # For external access\n  loadBalancerSourceRanges:\n  # University IP ranges (adjust as needed)\n  - \"10.0.0.0/8\"\n  - \"172.16.0.0/12\"\n  - \"192.168.0.0/16\"\n  ports:\n  - port: 80\n    targetPort: 80\n    protocol: TCP\n    name: http\n  - port: 443\n    targetPort: 443\n    protocol: TCP\n    name: https\n  selector:\n    app: epcalculator-nginx\n    component: frontend\n\n---\n# Nginx frontend deployment\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: epcalculator-nginx\n  namespace: epcalculator\n  labels:\n    app: epcalculator-nginx\n    component: frontend\nspec:\n  replicas: 2\n  selector:\n    matchLabels:\n      app: epcalculator-nginx\n      component: frontend\n  template:\n    metadata:\n      labels:\n        app: epcalculator-nginx\n        component: frontend\n    spec:\n      securityContext:\n        runAsNonRoot: true\n        runAsUser: 101  # nginx user\n        runAsGroup: 101\n      containers:\n      - name: nginx\n        image: nginx:1.25-alpine\n        ports:\n        - containerPort: 80\n          name: http\n        resources:\n          requests:\n            memory: \"64Mi\"\n            cpu: \"50m\"\n          limits:\n            memory: \"128Mi\"\n            cpu: \"100m\"\n        volumeMounts:\n        - name: nginx-config\n          mountPath: /etc/nginx/nginx.conf\n          subPath: nginx.conf\n        - name: static-content\n          mountPath: /usr/share/nginx/html\n        - name: tmp-volume\n          mountPath: /tmp\n        - name: var-cache-nginx\n          mountPath: /var/cache/nginx\n        - name: var-run\n          mountPath: /var/run\n        livenessProbe:\n          httpGet:\n            path: /health\n            port: 80\n          initialDelaySeconds: 10\n          periodSeconds: 10\n        readinessProbe:\n          httpGet:\n            path: /health\n            port: 80\n          initialDelaySeconds: 5\n          periodSeconds: 5\n        securityContext:\n          allowPrivilegeEscalation: false\n          readOnlyRootFilesystem: true\n          capabilities:\n            drop:\n            - ALL\n      volumes:\n      - name: nginx-config\n        configMap:\n          name: nginx-config\n      - name: static-content\n        configMap:\n          name: epcalculator-static  # Will be created by build process\n      - name: tmp-volume\n        emptyDir: {}\n      - name: var-cache-nginx\n        emptyDir: {}\n      - name: var-run\n        emptyDir: {}\n\n---\n# Headless service for StatefulSet (if needed for database clustering)\napiVersion: v1\nkind: Service\nmetadata:\n  name: epcalculator-headless\n  namespace: epcalculator\n  labels:\n    app: epcalculator\n    service-type: headless\nspec:\n  clusterIP: None\n  ports:\n  - port: 8000\n    name: backend\n  selector:\n    app: epcalculator\n    component: backend\n\n---\n# Service monitor for Prometheus (if available)\napiVersion: v1\nkind: Service\nmetadata:\n  name: epcalculator-metrics\n  namespace: epcalculator\n  labels:\n    app: epcalculator\n    component: metrics\n  annotations:\n    prometheus.io/scrape: \"true\"\n    prometheus.io/port: \"8000\"\n    prometheus.io/path: \"/api/analytics\"\nspec:\n  type: ClusterIP\n  ports:\n  - port: 8000\n    targetPort: 8000\n    name: metrics\n  selector:\n    app: epcalculator\n    component: backend"