apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: epcalculator\n  namespace: epcalculator\n  labels:\n    app: epcalculator\n    version: \"2.0\"\n    component: backend\nspec:\n  replicas: 2  # High availability with minimal resource usage\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 1\n      maxSurge: 1\n  selector:\n    matchLabels:\n      app: epcalculator\n      component: backend\n  template:\n    metadata:\n      labels:\n        app: epcalculator\n        component: backend\n        version: \"2.0\"\n      annotations:\n        # Force pod restart on config changes\n        checksum/config: \"placeholder-for-config-hash\"\n    spec:\n      # Security context for university environment\n      securityContext:\n        runAsNonRoot: true\n        runAsUser: 1001\n        runAsGroup: 1001\n        fsGroup: 1001\n      \n      # Resource constraints for university servers\n      nodeSelector:\n        kubernetes.io/arch: amd64\n      \n      # Tolerate university server taints\n      tolerations:\n      - key: \"university-server\"\n        operator: \"Equal\"\n        value: \"true\"\n        effect: \"NoSchedule\"\n      \n      # Anti-affinity to spread pods across nodes\n      affinity:\n        podAntiAffinity:\n          preferredDuringSchedulingIgnoredDuringExecution:\n          - weight: 100\n            podAffinityTerm:\n              labelSelector:\n                matchExpressions:\n                - key: app\n                  operator: In\n                  values: [\"epcalculator\"]\n              topologyKey: kubernetes.io/hostname\n      \n      # Init container to ensure database directory exists\n      initContainers:\n      - name: init-db\n        image: busybox:1.36-alpine\n        command: ['sh', '-c']\n        args:\n        - |\n          mkdir -p /app/data\n          chown 1001:1001 /app/data\n          chmod 755 /app/data\n          echo \"Database directory initialized\"\n        volumeMounts:\n        - name: data-volume\n          mountPath: /app/data\n        securityContext:\n          runAsUser: 0  # Need root for chown\n      \n      containers:\n      - name: epcalculator\n        image: epcalculator:2.0\n        imagePullPolicy: IfNotPresent\n        \n        ports:\n        - containerPort: 8000\n          name: http\n          protocol: TCP\n        \n        # Environment variables from ConfigMap and Secrets\n        envFrom:\n        - configMapRef:\n            name: epcalculator-config\n        - secretRef:\n            name: epcalculator-secrets\n        \n        # Resource limits for university servers\n        resources:\n          requests:\n            memory: \"256Mi\"\n            cpu: \"200m\"\n          limits:\n            memory: \"512Mi\"\n            cpu: \"500m\"\n        \n        # Health checks\n        livenessProbe:\n          httpGet:\n            path: /api/health/live\n            port: 8000\n          initialDelaySeconds: 30\n          periodSeconds: 10\n          timeoutSeconds: 5\n          failureThreshold: 3\n        \n        readinessProbe:\n          httpGet:\n            path: /api/health/ready\n            port: 8000\n          initialDelaySeconds: 10\n          periodSeconds: 5\n          timeoutSeconds: 3\n          failureThreshold: 3\n        \n        # Startup probe for slower university servers\n        startupProbe:\n          httpGet:\n            path: /api/health/live\n            port: 8000\n          initialDelaySeconds: 5\n          periodSeconds: 5\n          timeoutSeconds: 3\n          failureThreshold: 12  # 60 seconds total\n        \n        # Volume mounts\n        volumeMounts:\n        - name: data-volume\n          mountPath: /app/data\n        - name: temp-volume\n          mountPath: /tmp\n        \n        # Security context\n        securityContext:\n          allowPrivilegeEscalation: false\n          readOnlyRootFilesystem: false  # Node.js needs write access\n          capabilities:\n            drop:\n            - ALL\n        \n        # Graceful shutdown\n        lifecycle:\n          preStop:\n            exec:\n              command: [\"/bin/sh\", \"-c\", \"sleep 10\"]\n      \n      # Volumes\n      volumes:\n      - name: data-volume\n        persistentVolumeClaim:\n          claimName: epcalculator-data\n      - name: temp-volume\n        emptyDir:\n          sizeLimit: 100Mi\n      \n      # DNS configuration for university network\n      dnsPolicy: ClusterFirst\n      dnsConfig:\n        options:\n        - name: ndots\n          value: \"2\"\n        - name: edns0\n      \n      # Graceful termination\n      terminationGracePeriodSeconds: 30\n      \n      # Restart policy\n      restartPolicy: Always\n\n---\n# Horizontal Pod Autoscaler for automatic scaling\napiVersion: autoscaling/v2\nkind: HorizontalPodAutoscaler\nmetadata:\n  name: epcalculator-hpa\n  namespace: epcalculator\n  labels:\n    app: epcalculator\nspec:\n  scaleTargetRef:\n    apiVersion: apps/v1\n    kind: Deployment\n    name: epcalculator\n  minReplicas: 1\n  maxReplicas: 4  # Limited for university resources\n  metrics:\n  - type: Resource\n    resource:\n      name: cpu\n      target:\n        type: Utilization\n        averageUtilization: 70\n  - type: Resource\n    resource:\n      name: memory\n      target:\n        type: Utilization\n        averageUtilization: 80\n  behavior:\n    scaleDown:\n      stabilizationWindowSeconds: 300\n      policies:\n      - type: Percent\n        value: 50\n        periodSeconds: 60\n    scaleUp:\n      stabilizationWindowSeconds: 60\n      policies:\n      - type: Percent\n        value: 100\n        periodSeconds: 30\n      - type: Pods\n        value: 1\n        periodSeconds: 60"