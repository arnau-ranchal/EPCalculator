# ServiceMonitor for Prometheus monitoring (if available)\napiVersion: monitoring.coreos.com/v1\nkind: ServiceMonitor\nmetadata:\n  name: epcalculator-monitor\n  namespace: epcalculator\n  labels:\n    app: epcalculator\n    component: monitoring\nspec:\n  selector:\n    matchLabels:\n      app: epcalculator\n      component: metrics\n  endpoints:\n  - port: metrics\n    path: /api/analytics\n    interval: 30s\n    scrapeTimeout: 10s\n  namespaceSelector:\n    matchNames:\n    - epcalculator\n\n---\n# Basic monitoring dashboard ConfigMap\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: epcalculator-dashboard\n  namespace: epcalculator\n  labels:\n    app: epcalculator\n    component: monitoring\n    grafana_dashboard: \"1\"\ndata:\n  dashboard.json: |\n    {\n      \"dashboard\": {\n        \"id\": null,\n        \"title\": \"EPCalculator v2 - University Monitoring\",\n        \"tags\": [\"epcalculator\", \"university\", \"transmission-systems\"],\n        \"style\": \"dark\",\n        \"timezone\": \"browser\",\n        \"panels\": [\n          {\n            \"id\": 1,\n            \"title\": \"Active Users\",\n            \"type\": \"stat\",\n            \"targets\": [\n              {\n                \"expr\": \"epcalculator_active_users\",\n                \"legendFormat\": \"Active Users\"\n              }\n            ],\n            \"gridPos\": {\"h\": 8, \"w\": 12, \"x\": 0, \"y\": 0}\n          },\n          {\n            \"id\": 2,\n            \"title\": \"Computations per Minute\",\n            \"type\": \"graph\",\n            \"targets\": [\n              {\n                \"expr\": \"rate(epcalculator_computations_total[1m])\",\n                \"legendFormat\": \"Computations/min\"\n              }\n            ],\n            \"gridPos\": {\"h\": 8, \"w\": 12, \"x\": 12, \"y\": 0}\n          },\n          {\n            \"id\": 3,\n            \"title\": \"Average Computation Time\",\n            \"type\": \"graph\",\n            \"targets\": [\n              {\n                \"expr\": \"epcalculator_computation_duration_avg\",\n                \"legendFormat\": \"Avg Duration (ms)\"\n              }\n            ],\n            \"gridPos\": {\"h\": 8, \"w\": 12, \"x\": 0, \"y\": 8}\n          },\n          {\n            \"id\": 4,\n            \"title\": \"Memory Usage\",\n            \"type\": \"graph\",\n            \"targets\": [\n              {\n                \"expr\": \"container_memory_usage_bytes{pod=~\\\"epcalculator-.*\\\"}\",\n                \"legendFormat\": \"Memory Usage\"\n              }\n            ],\n            \"gridPos\": {\"h\": 8, \"w\": 12, \"x\": 12, \"y\": 8}\n          }\n        ],\n        \"time\": {\n          \"from\": \"now-1h\",\n          \"to\": \"now\"\n        },\n        \"refresh\": \"30s\"\n      }\n    }\n\n---\n# Log aggregation configuration for university environment\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: epcalculator-logging\n  namespace: epcalculator\n  labels:\n    app: epcalculator\n    component: logging\ndata:\n  fluent-bit.conf: |\n    [SERVICE]\n        Flush         5\n        Log_Level     info\n        Daemon        off\n        Parsers_File  parsers.conf\n        HTTP_Server   On\n        HTTP_Listen   0.0.0.0\n        HTTP_Port     2020\n    \n    [INPUT]\n        Name              tail\n        Path              /var/log/containers/*epcalculator*.log\n        Parser            cri\n        Tag               epcalculator.*\n        Refresh_Interval  5\n        Mem_Buf_Limit     50MB\n        Skip_Long_Lines   On\n    \n    [FILTER]\n        Name                kubernetes\n        Match               epcalculator.*\n        Kube_URL            https://kubernetes.default.svc:443\n        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt\n        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token\n        Kube_Tag_Prefix     epcalculator.var.log.containers.\n        Merge_Log           On\n        Keep_Log            Off\n        K8S-Logging.Parser  On\n        K8S-Logging.Exclude Off\n    \n    [FILTER]\n        Name    grep\n        Match   epcalculator.*\n        Regex   log (ERROR|WARN|INFO)\n    \n    [OUTPUT]\n        Name  stdout\n        Match epcalculator.*\n        Format json_lines\n  \n  parsers.conf: |\n    [PARSER]\n        Name        cri\n        Format      regex\n        Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$\n        Time_Key    time\n        Time_Format %Y-%m-%dT%H:%M:%S.%L%z\n\n---\n# Alert rules for university monitoring\napiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  name: epcalculator-alerts\n  namespace: epcalculator\n  labels:\n    app: epcalculator\n    component: monitoring\nspec:\n  groups:\n  - name: epcalculator.rules\n    rules:\n    # High memory usage alert\n    - alert: EPCalculatorHighMemoryUsage\n      expr: |\n        (\n          container_memory_usage_bytes{pod=~\"epcalculator-.*\"} / \n          container_spec_memory_limit_bytes{pod=~\"epcalculator-.*\"}\n        ) * 100 > 85\n      for: 5m\n      labels:\n        severity: warning\n        service: epcalculator\n      annotations:\n        summary: \"EPCalculator high memory usage\"\n        description: \"EPCalculator pod {{ $labels.pod }} memory usage is {{ $value }}%\"\n    \n    # High CPU usage alert\n    - alert: EPCalculatorHighCPUUsage\n      expr: |\n        (\n          rate(container_cpu_usage_seconds_total{pod=~\"epcalculator-.*\"}[5m]) / \n          container_spec_cpu_quota{pod=~\"epcalculator-.*\"} * \n          container_spec_cpu_period{pod=~\"epcalculator-.*\"}\n        ) * 100 > 80\n      for: 5m\n      labels:\n        severity: warning\n        service: epcalculator\n      annotations:\n        summary: \"EPCalculator high CPU usage\"\n        description: \"EPCalculator pod {{ $labels.pod }} CPU usage is {{ $value }}%\"\n    \n    # Too many active users alert\n    - alert: EPCalculatorTooManyUsers\n      expr: epcalculator_active_users > 45  # Alert when approaching limit\n      for: 2m\n      labels:\n        severity: warning\n        service: epcalculator\n      annotations:\n        summary: \"EPCalculator approaching user limit\"\n        description: \"EPCalculator has {{ $value }} active users (limit: 50)\"\n    \n    # Pod not ready alert\n    - alert: EPCalculatorPodNotReady\n      expr: |\n        kube_pod_status_ready{condition=\"false\", pod=~\"epcalculator-.*\"} == 1\n      for: 5m\n      labels:\n        severity: critical\n        service: epcalculator\n      annotations:\n        summary: \"EPCalculator pod not ready\"\n        description: \"EPCalculator pod {{ $labels.pod }} has been not ready for more than 5 minutes\"\n    \n    # Database size alert\n    - alert: EPCalculatorDatabaseLarge\n      expr: epcalculator_database_size_mb > 4000  # Alert when approaching 4GB\n      for: 10m\n      labels:\n        severity: warning\n        service: epcalculator\n      annotations:\n        summary: \"EPCalculator database getting large\"\n        description: \"EPCalculator database size is {{ $value }}MB\""